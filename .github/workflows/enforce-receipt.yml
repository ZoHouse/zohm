name: Enforce Receipt for Protected Paths

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-receipt:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare branches
      
      - name: Get changed files
        id: changed-files
        run: |
          echo "Getting changed files between base and head..."
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$FILES"
          
          # Save to environment
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Check for protected path changes
        id: check-protected
        run: |
          echo "Checking for changes to protected paths..."
          
          PROTECTED_PATTERNS=(
            "^packages/contracts/"
            "^infra/"
            "^\.github/workflows/"
            "^migrations/.*\.sql$"
            "^Docs/CONSTRAINTS\.md$"
            "^Docs/API_CONTRACTS\.md$"
          )
          
          PROTECTED_FOUND=false
          
          for pattern in "${PROTECTED_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -qE "$pattern"; then
              echo "‚úã Protected path detected: $pattern"
              PROTECTED_FOUND=true
            fi
          done
          
          if [ "$PROTECTED_FOUND" = true ]; then
            echo "protected=true" >> $GITHUB_OUTPUT
          else
            echo "protected=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for receipt
        if: steps.check-protected.outputs.protected == 'true'
        run: |
          echo "üîç Protected paths modified. Checking for receipt..."
          
          # Check if receipts/drafts directory exists and has files
          if [ ! -d "Docs/RECEIPTS/drafts" ]; then
            echo "‚ùå ERROR: Docs/RECEIPTS/drafts/ directory not found"
            exit 1
          fi
          
          # Count draft receipts
          DRAFT_COUNT=$(ls -1 Docs/RECEIPTS/drafts/*.json 2>/dev/null | wc -l | tr -d ' ')
          
          if [ "$DRAFT_COUNT" -eq 0 ]; then
            echo ""
            echo "‚ùå ERROR: No receipt found in Docs/RECEIPTS/drafts/"
            echo ""
            echo "Protected paths were modified but no receipt was generated."
            echo ""
            echo "To fix this:"
            echo "  1. Run: python3 scripts/generate_receipt.py"
            echo "  2. Fill out the generated receipt with details"
            echo "  3. Commit the receipt: git add Docs/RECEIPTS/drafts/ && git commit -m 'docs: add receipt'"
            echo "  4. Push changes: git push"
            echo ""
            echo "See Docs/RECEIPTS/README.md for more information."
            echo ""
            exit 1
          fi
          
          echo "‚úÖ Receipt found: $DRAFT_COUNT draft receipt(s) in Docs/RECEIPTS/drafts/"
          
          # Show receipt details
          for receipt in Docs/RECEIPTS/drafts/*.json; do
            echo ""
            echo "üìÑ Receipt: $(basename $receipt)"
            echo "Summary: $(jq -r '.summary // "No summary"' $receipt)"
            echo "Type: $(jq -r '.type // "unknown"' $receipt)"
            echo "Author: $(jq -r '.author // "unknown"' $receipt)"
          done
      
      - name: Validate receipt format
        if: steps.check-protected.outputs.protected == 'true'
        run: |
          echo "üîç Validating receipt format..."
          
          for receipt in Docs/RECEIPTS/drafts/*.json; do
            echo "Checking $receipt..."
            
            # Check if valid JSON
            if ! jq empty "$receipt" 2>/dev/null; then
              echo "‚ùå ERROR: $receipt is not valid JSON"
              exit 1
            fi
            
            # Check required fields
            REQUIRED_FIELDS=("receipt_id" "branch" "commit" "timestamp" "author" "type" "summary")
            
            for field in "${REQUIRED_FIELDS[@]}"; do
              VALUE=$(jq -r ".$field // empty" "$receipt")
              if [ -z "$VALUE" ]; then
                echo "‚ùå ERROR: Required field '$field' is missing or empty in $receipt"
                exit 1
              fi
            done
            
            echo "‚úÖ $receipt is valid"
          done
      
      - name: Success message
        if: steps.check-protected.outputs.protected == 'false'
        run: |
          echo "‚úÖ No protected paths modified. Receipt not required."
      
      - name: Comment on PR (if receipt missing)
        if: failure() && steps.check-protected.outputs.protected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Receipt Required

This PR modifies protected paths but no receipt was found.

### To fix this:

\`\`\`bash
# 1. Generate a receipt
python3 scripts/generate_receipt.py

# 2. Fill out the generated receipt
# Edit: Docs/RECEIPTS/drafts/<receipt-id>.json

# 3. Commit and push
git add Docs/RECEIPTS/drafts/
git commit -m "docs: add receipt for protected path changes"
git push
\`\`\`

### Protected paths detected:
- \`packages/contracts/\`
- \`infra/\`
- \`.github/workflows/\`
- \`migrations/*.sql\`
- \`Docs/CONSTRAINTS.md\`
- \`Docs/API_CONTRACTS.md\`

See [Docs/RECEIPTS/README.md](../blob/main/Docs/RECEIPTS/README.md) for more information.
`
            })

