# New User Funnel - Complete Deep Dive Analysis
## ğŸ¯ Overview: Brand New User (Never Used ZO Before)

This document provides an **exhaustive technical analysis** of how a completely new user is created, authenticated, onboarded, and stored in the Zo World system.

**Scope**: This analysis focuses **exclusively** on **Type 1 users** - users who have never used any ZO product before.

**Source of Truth**: This document is based on:
- âœ… Live production code from Zo World Mobile App (React Native)
- âœ… Zo World Web App implementation (aligned with mobile)
- âœ… Actual ZO API behavior (confirmed via production usage)

**Last Updated**: November 23, 2025  
**Status**: âœ… Accurate & Production-Verified

---

## ğŸ“Š High-Level Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                       â”‚
â”‚  LANDING PAGE â†’ PHONE AUTH â†’ DB CREATION â†’ ONBOARDING â†’ DASHBOARD   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Landing Page (Unauthenticated)
Step 2: Phone Login Modal (OTP Flow)
Step 3: Database User Creation (Supabase INSERT)
Step 4: Profile Sync from ZO API
Step 5: Onboarding Flow (Nickname â†’ Avatar â†’ Card â†’ Portal)
Step 6: Voice Quest (Game1111)
Step 7: Dashboard (Fully Onboarded)
```

---

## ğŸ” STEP 1: Landing Page

### File
`apps/web/src/components/LandingPage.tsx`

### State
```typescript
authenticated = false
ready = true
userProfile = null
```

### UI Elements
- Video background (`/videos/landing-screen-background.mp4`)
- **"Tune into Zo World"** button (primary CTA)
- "Email" button (alternative - not implemented)
- "Wallet" button (alternative - not implemented)

### User Action
User clicks **"Tune into Zo World"**

### What Happens
1. Opens `PhoneLoginModal` component
2. Modal state: `isOpen = true`

---

## ğŸ“± STEP 2: Phone Authentication (OTP Flow)

### File
`apps/web/src/components/PhoneLoginModal.tsx`

### Sub-Flow

#### 2.1: Phone Number Entry

**UI State**: `step = 'phone'`

**User Input**:
- Country code dropdown (default: +1)
- Phone number input field

**Validation**:
- Phone number must be 10 digits (US format)
- Only numbers allowed

**User Action**: Clicks "Send Code"

**API Call 1: Send OTP**

```typescript
// Frontend call
const response = await fetch('/api/zo/auth/send-otp', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    countryCode: '+1',
    phoneNumber: '5551234567'
  })
});
```

**Backend Route**: `apps/web/src/app/api/zo/auth/send-otp/route.ts`

**Backend Implementation**:
```typescript
import { sendOTP } from '@/lib/zo-api/auth';

export async function POST(request: NextRequest) {
  const { countryCode, phoneNumber } = await request.json();
  
  // Call ZO API
  const result = await sendOTP(countryCode, phoneNumber);
  
  return NextResponse.json(result);
}
```

**ZO API Call**: `apps/web/src/lib/zo-api/auth.ts`

```typescript
export async function sendOTP(
  countryCode: string,
  phoneNumber: string
): Promise<{ success: boolean; message: string }> {
  const payload: ZoAuthOTPRequest = {
    mobile_country_code: countryCode,
    mobile_number: phoneNumber,
    message_channel: '', // Empty string as per ZO API spec
  };
  
  const response = await zoApiClient.post(
    '/api/v1/auth/login/mobile/otp/',
    payload
  );
  
  return {
    success: true,
    message: 'OTP sent successfully',
  };
}
```

**ZO API Endpoint**: `POST https://api.io.zo.xyz/api/v1/auth/login/mobile/otp/`

**Request Headers**:
```
Content-Type: application/json
client-key: <ZO_CLIENT_KEY_WEB>
client-device-id: <auto-generated UUID>
client-device-secret: <auto-generated UUID>
```

**Request Body**:
```json
{
  "mobile_country_code": "+1",
  "mobile_number": "5551234567",
  "message_channel": ""
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "OTP sent successfully"
}
```

**What Happens**:
- ZO API sends SMS with 6-digit OTP code to user's phone
- Frontend transitions to OTP entry screen

---

#### 2.2: OTP Code Entry

**UI State**: `step = 'otp'`

**User Input**:
- 6-digit OTP code input

**User Action**: Enters 6 digits (auto-submits on 6th digit)

**API Call 2: Verify OTP**

```typescript
// Frontend call
const response = await fetch('/api/zo/auth/verify-otp', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    countryCode: '+1',
    phoneNumber: '5551234567',
    otp: '123456'
  })
});
```

**Backend Route**: `apps/web/src/app/api/zo/auth/verify-otp/route.ts`

This is the **CRITICAL** route where the user is created in our database.

---

## ğŸ’¾ STEP 3: Database User Creation (The Core Logic)

### File
`apps/web/src/app/api/zo/auth/verify-otp/route.ts`

### Complete Flow Breakdown

#### 3.1: Verify OTP with ZO API

```typescript
// Call ZO API to verify OTP
const result = await verifyOTP(countryCode, phoneNumber, otp);

if (!result.success || !result.data) {
  return NextResponse.json(
    { error: result.error || 'Invalid OTP' },
    { status: 400 }
  );
}
```

**ZO API Call**: `POST https://api.io.zo.xyz/api/v1/auth/login/mobile/`

**Request Body**:
```json
{
  "mobile_country_code": "+1",
  "mobile_number": "5551234567",
  "otp": "123456"
}
```

**Response** (200 OK):
```json
{
  "user": {
    "id": "usr_abc123",
    "pid": "p_xyz789",
    "first_name": "John",
    "last_name": "Doe",
    "mobile_number": "5551234567",
    "email_address": "john@example.com",
    "membership": "citizen"
  },
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "access_token_expiry": "2025-11-24T12:00:00Z",
  "refresh_token_expiry": "2025-12-24T12:00:00Z",
  "device_id": "dev_abc123",
  "device_secret": "secret_xyz789",
  "token": "legacy_token_abc",
  "valid_till": "2025-11-24T12:00:00Z",
  "client_key": "client_key_abc",
  "device_info": {
    "platform": "web",
    "browser": "Chrome"
  }
}
```

**Key Fields**:
- `user.id` - ZO User ID (used as primary key in Supabase)
- `user.pid` - ZO Profile ID (permanent identifier)
- `access_token` - JWT for authenticated API calls
- `refresh_token` - Token for refreshing access token
- `device_id` + `device_secret` - Required for all subsequent ZO API calls

---

#### 3.2: Check if User Exists in Supabase

```typescript
// Step 1: Check if user exists by zo_user_id (most reliable)
const { data: existingByZoId } = await supabase
  .from('users')
  .select('id')
  .eq('zo_user_id', user.id)
  .single();

if (existingByZoId) {
  targetUserId = existingByZoId.id;
  console.log('âœ… Found existing user by zo_user_id:', targetUserId);
} else {
  // Step 2: Check if user exists by phone number
  const { data: existingByPhone } = await supabase
    .from('users')
    .select('id')
    .eq('phone', user.mobile_number)
    .single();

  if (existingByPhone) {
    targetUserId = existingByPhone.id;
    console.log('âœ… Found existing user by phone:', targetUserId);
  } else {
    // User does not exist - CREATE NEW USER
    // ...
  }
}
```

**Query 1**: `SELECT id FROM users WHERE zo_user_id = 'usr_abc123'`
**Query 2**: `SELECT id FROM users WHERE phone = '5551234567'`

**Result for Brand New User**: Both queries return `null`

---

#### 3.3: Create New User in Supabase

**This is where the magic happens for new users!**

```typescript
// Step 3: Create new user with ZO identity
// For ZO users, use zo_user_id as the primary id
const { data: newUser, error: createError } = await supabase
  .from('users')
  .insert({
    id: user.id,  // Use zo_user_id as the primary id
    zo_user_id: user.id,
    zo_pid: user.pid,
    name: `${user.first_name} ${user.last_name}`.trim(),
    phone: user.mobile_number,
    email: user.email_address,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
  })
  .select('id')
  .single();

if (createError || !newUser) {
  // Handle error (unique constraint violation, etc.)
  // ...
} else {
  targetUserId = newUser.id;
  console.log('âœ… Created new user:', targetUserId);
}
```

**SQL INSERT**:
```sql
INSERT INTO users (
  id,
  zo_user_id,
  zo_pid,
  name,
  phone,
  email,
  created_at,
  updated_at
) VALUES (
  'usr_abc123',
  'usr_abc123',
  'p_xyz789',
  'John Doe',
  '5551234567',
  'john@example.com',
  '2025-11-23T12:00:00Z',
  '2025-11-23T12:00:00Z'
)
RETURNING id;
```

**Database State After INSERT**:
```
users table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ zo_user_id   â”‚ zo_pid    â”‚ name      â”‚ phone       â”‚ email            â”‚ created_at           â”‚ updated_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ usr_abc123   â”‚ p_xyz789  â”‚ John Doe  â”‚ 5551234567  â”‚ john@example.com â”‚ 2025-11-23T12:00:00Z â”‚ 2025-11-23T12:00:00Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All other fields are NULL or default values:
- pfp: NULL
- bio: NULL
- culture: NULL
- lat: NULL
- lng: NULL
- city: NULL
- role: 'Member' (default)
- zo_balance: 0 (default)
- onboarding_completed: FALSE (default)
- onboarding_step: 0 (default)
```

---

#### 3.4: Save Device Credentials

**CRITICAL**: Device credentials must be saved for all subsequent ZO API calls.

```typescript
// STEP 1: Save device credentials to database FIRST
const { error: deviceError } = await supabase
  .from('users')
  .update({
    zo_device_id: device_id,
    zo_device_secret: device_secret,
    updated_at: new Date().toISOString(),
  })
  .eq('id', targetUserId);

if (deviceError) {
  console.error('âš ï¸ Failed to save device credentials:', deviceError);
} else {
  console.log('âœ… Device credentials saved to database');
}
```

**SQL UPDATE**:
```sql
UPDATE users
SET 
  zo_device_id = 'dev_abc123',
  zo_device_secret = 'secret_xyz789',
  updated_at = '2025-11-23T12:00:01Z'
WHERE id = 'usr_abc123';
```

---

#### 3.5: Save ZO Auth Data

```typescript
// STEP 2: Save basic ZO auth data to Supabase (fast)
const { error: authUpdateError } = await supabase
  .from('users')
  .update({
    zo_user_id: user.id,
    zo_pid: user.pid,
    zo_token: access_token,
    zo_refresh_token: refresh_token,
    zo_token_expiry: access_token_expiry,
    zo_refresh_token_expiry: refresh_token_expiry,
    zo_legacy_token: token,
    zo_legacy_token_valid_till: valid_till,
    zo_client_key: client_key,
    zo_device_info: device_info || {},
    zo_membership: user.membership,
    name: `${user.first_name} ${user.last_name}`.trim() || user.first_name,
    updated_at: new Date().toISOString(),
  })
  .eq('id', targetUserId);
```

**SQL UPDATE**:
```sql
UPDATE users
SET 
  zo_user_id = 'usr_abc123',
  zo_pid = 'p_xyz789',
  zo_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  zo_refresh_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
  zo_token_expiry = '2025-11-24T12:00:00Z',
  zo_refresh_token_expiry = '2025-12-24T12:00:00Z',
  zo_legacy_token = 'legacy_token_abc',
  zo_legacy_token_valid_till = '2025-11-24T12:00:00Z',
  zo_client_key = 'client_key_abc',
  zo_device_info = '{"platform":"web","browser":"Chrome"}',
  zo_membership = 'citizen',
  name = 'John Doe',
  updated_at = '2025-11-23T12:00:02Z'
WHERE id = 'usr_abc123';
```

---

#### 3.6: Sync Full Profile from ZO API

**This is BLOCKING** - ensures avatar and all profile fields are synced.

```typescript
// STEP 3: Sync full profile (BLOCKING - ensures avatar is saved)
console.log('ğŸ”„ Syncing full profile from ZO API...');
const syncResult = await syncZoProfileToSupabase(
  targetUserId,
  access_token,
  {
    zo_user_id: user.id,
    zo_pid: user.pid,
    zo_token: access_token,
    zo_refresh_token: refresh_token,
    zo_token_expiry: access_token_expiry,
    zo_refresh_token_expiry: refresh_token_expiry,
    device_id,
    device_secret,
    zo_legacy_token: token,
    zo_legacy_token_valid_till: valid_till,
    zo_client_key: client_key,
    zo_device_info: device_info || {},
    zo_membership: user.membership,
  }
);

if (!syncResult.success) {
  console.error('âŒ Profile sync failed:', syncResult.error);
  // Continue anyway - basic auth data is already saved
} else {
  console.log('âœ… Full profile synced from ZO API (including avatar)');
}
```

**Function**: `syncZoProfileToSupabase()` in `apps/web/src/lib/zo-api/sync.ts`

**What it does**:
1. Calls ZO API: `GET https://api.io.zo.xyz/api/v1/profile/me/`
2. Fetches full user profile including:
   - `avatar.image` (generated avatar URL)
   - `pfp_image` (default profile pic)
   - `cultures` (array of culture affiliations)
   - `founder_tokens` (NFT ownership)
   - `wallet_address` (blockchain wallet)
   - `home_location` (lat/lng)
   - `place_name` (city)
3. Updates Supabase with all fields

**ZO API Request**:
```
GET https://api.io.zo.xyz/api/v1/profile/me/
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  client-key: <ZO_CLIENT_KEY_WEB>
  client-device-id: dev_abc123
  client-device-secret: secret_xyz789
```

**ZO API Response**:
```json
{
  "id": "usr_abc123",
  "pid": "p_xyz789",
  "first_name": "John",
  "last_name": "Doe",
  "email_address": "john@example.com",
  "mobile_number": "5551234567",
  "date_of_birth": null,
  "bio": null,
  "avatar": {
    "image": null,
    "status": "pending"
  },
  "pfp_image": "https://cdn.zo.xyz/default-avatar.png",
  "cultures": [],
  "founder_tokens": [],
  "wallet_address": "0x1234567890abcdef",
  "home_location": null,
  "place_name": null,
  "body_type": null,
  "membership": "citizen"
}
```

**SQL UPDATE** (from sync):
```sql
UPDATE users
SET 
  name = 'John Doe',
  bio = NULL,
  email = 'john@example.com',
  phone = '5551234567',
  birthdate = NULL,
  pfp = 'https://cdn.zo.xyz/default-avatar.png',
  cultures = '[]',
  body_type = NULL,
  city = NULL,
  zo_home_location = NULL,
  zo_membership = 'citizen',
  founder_nfts_count = 0,
  primary_wallet_address = '0x1234567890abcdef',
  zo_synced_at = '2025-11-23T12:00:03Z',
  zo_sync_status = 'synced',
  updated_at = '2025-11-23T12:00:03Z'
WHERE id = 'usr_abc123';
```

**Database State After Sync**:
```
users table (usr_abc123):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ zo_user_id   â”‚ zo_pid    â”‚ name      â”‚ phone       â”‚ email            â”‚ pfp                             â”‚ zo_synced_at         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ usr_abc123   â”‚ p_xyz789  â”‚ John Doe  â”‚ 5551234567  â”‚ john@example.com â”‚ https://cdn.zo.xyz/default.png  â”‚ 2025-11-23T12:00:03Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Additional fields:
- cultures: []
- founder_nfts_count: 0
- primary_wallet_address: 0x1234567890abcdef
- zo_membership: 'citizen'
- onboarding_completed: FALSE
```

---

#### 3.7: Return Response to Frontend

```typescript
return NextResponse.json({
  success: true,
  userId: targetUserId,
  user: {
    id: user.id,
    pid: user.pid,
    name: `${user.first_name} ${user.last_name}`.trim(),
    phone: user.mobile_number,
  },
  tokens: {
    access: access_token,
    refresh: refresh_token,
    accessExpiry: access_token_expiry,
    refreshExpiry: refresh_token_expiry,
  },
});
```

**Frontend receives**:
```json
{
  "success": true,
  "userId": "usr_abc123",
  "user": {
    "id": "usr_abc123",
    "pid": "p_xyz789",
    "name": "John Doe",
    "phone": "5551234567"
  },
  "tokens": {
    "access": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "accessExpiry": "2025-11-24T12:00:00Z",
    "refreshExpiry": "2025-12-24T12:00:00Z"
  }
}
```

---

#### 3.8: Frontend Saves Session to localStorage

**File**: `apps/web/src/components/PhoneLoginModal.tsx`

```typescript
// Save to localStorage
localStorage.setItem('zo_user_id', data.userId);
localStorage.setItem('zo_access_token', data.tokens.access);
localStorage.setItem('zo_refresh_token', data.tokens.refresh);
localStorage.setItem('zo_token_expiry', data.tokens.accessExpiry);

// Dispatch event for other components
window.dispatchEvent(new Event('zoLoginSuccess'));

// Close modal
onSuccess();
```

**localStorage State**:
```
zo_user_id: "usr_abc123"
zo_access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
zo_refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
zo_token_expiry: "2025-11-24T12:00:00Z"
```

---

## ğŸ¨ STEP 4: Onboarding Flow (Profile Setup)

### Hook: useZoAuth

**File**: `apps/web/src/hooks/useZoAuth.ts`

After login, the app checks the user's onboarding status:

```typescript
const loadUserProfile = useCallback(async () => {
  const zoUserId = localStorage.getItem('zo_user_id');
  
  if (!zoUserId) {
    setUserProfile(null);
    return;
  }
  
  // Load profile from Supabase
  let profile = await getFullUserProfile(zoUserId);
  
  if (profile) {
    setUserProfile(profile);
  }
}, []);
```

**Query**:
```sql
SELECT * FROM users WHERE id = 'usr_abc123';
```

**Result**:
```json
{
  "id": "usr_abc123",
  "name": "John Doe",
  "pfp": "https://cdn.zo.xyz/default.png",
  "onboarding_completed": false,
  "onboarding_step": 0
}
```

**Decision Logic** (in `apps/web/src/app/page.tsx`):
```typescript
if (!hasCompletedOnboarding) {
  // Show Onboarding2
  return <Onboarding2 onComplete={handleOnboardingComplete} userId={userId} />;
}
```

---

### Onboarding2 Component

**File**: `apps/web/src/components/Onboarding2.tsx`

**Flow**: `nickname` â†’ `avatar` â†’ `card` â†’ `portal`

---

#### 4.1: Nickname Step

**File**: `apps/web/src/components/NicknameStep.tsx`

**UI**:
- Title: "WHO ARE YOU?"
- Subtitle: "A difficult question, I know. We'll get to it. But let's start with choosing a nick."
- Nickname input (4-16 characters, lowercase alphanumeric)
- Body type selector (Bro / Bae)
- Location button (optional)
- "Get Citizenship" button

**User Input**:
- Nickname: `samurai`
- Body type: `bro`
- City: `San Francisco` (via geolocation)

**User Action**: Clicks "Get Citizenship"

**Frontend Logic**:
```typescript
const handleGetCitizenship = async () => {
  // Save to database
  const user = await upsertUserFromPrivy(authUser as any, {
    name: nickname,
    city: city || null,
    body_type: bodyType,
  });
  
  // Save to localStorage for next step
  localStorage.setItem('zo_nickname', nickname);
  localStorage.setItem('zo_city', city);
  localStorage.setItem('zo_body_type', bodyType);
  
  // Move to next step
  onNicknameSet();
};
```

**Function**: `upsertUserFromPrivy()` in `apps/web/src/lib/userDb.ts`

```typescript
export async function upsertUserFromPrivy(
  user: { id: string; email?: string | { address?: string } | null },
  profileData?: Partial<UserRecord>
): Promise<UserRecord | null> {
  const userData: Partial<UserRecord> = {
    id: user.id,
    email: userEmail,
    last_seen: new Date().toISOString(),
    ...profileData,
  };
  
  const { data, error } = await supabase
    .from('users')
    .upsert(userData, { onConflict: 'id' })
    .select()
    .single();
  
  return data;
}
```

**SQL UPSERT**:
```sql
INSERT INTO users (id, name, city, body_type, last_seen, updated_at)
VALUES ('usr_abc123', 'samurai', 'San Francisco', 'bro', '2025-11-23T12:01:00Z', '2025-11-23T12:01:00Z')
ON CONFLICT (id) DO UPDATE SET
  name = EXCLUDED.name,
  city = EXCLUDED.city,
  body_type = EXCLUDED.body_type,
  last_seen = EXCLUDED.last_seen,
  updated_at = EXCLUDED.updated_at
RETURNING *;
```

**Database State After Nickname Step**:
```
users table (usr_abc123):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ name      â”‚ city             â”‚ body_type â”‚ updated_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ samurai   â”‚ San Francisco    â”‚ bro       â”‚ 2025-11-23T12:01:00Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**localStorage State**:
```
zo_nickname: "samurai"
zo_city: "San Francisco"
zo_body_type: "bro"
```

---

#### 4.2: Avatar Step

**File**: `apps/web/src/components/AvatarStep.tsx`

**Auto-starts on mount** - no user interaction required.

**Important Note on Avatar Generation**:

Avatar generation is triggered by `POST /api/v1/profile/me/` with `body_type`:
- The ZO API backend automatically starts avatar generation when it sees `body_type` in the request
- No separate "generate avatar" API call needed
- Frontend polls `GET /api/v1/profile/me/` to check if `avatar.image` is populated
- **Source of Truth**: Mobile app implementation (confirmed from production code)

**Alternative Flow** (not used for new users):
- There's also a `POST /api/v1/avatar/generate/` endpoint
- Used in some legacy flows (link-account)
- New user flow uses the profile update approach (simpler, fewer API calls)

**Flow**:
1. Read `body_type` from localStorage
2. Call ZO API to update profile (triggers avatar generation)
3. Poll ZO API for avatar completion
4. Save avatar URL to Supabase
5. Auto-advance to next step

**API Call 1: Update Profile (Triggers Avatar Generation)**

```typescript
const { updateProfile } = await import('@/lib/zo-api/profile');
const result = await updateProfile(accessToken, {
  first_name: nickname || undefined,
  body_type: bodyType,
  place_name: city || undefined
}, userId);
```

**Function**: `updateProfile()` in `apps/web/src/lib/zo-api/profile.ts`

**Implementation**:
```typescript
export async function updateProfile(
  accessToken: string,
  updates: ZoProfileUpdatePayload,
  userId?: string
): Promise<{
  success: boolean;
  profile?: ZoProfileResponse;
  error?: string;
}> {
  const headers = await getZoAuthHeaders(accessToken, userId);
  const response = await zoApiClient.post<ZoProfileResponse>(
    '/api/v1/profile/me/',
    updates,
    { headers }
  );

  return {
    success: true,
    profile: response.data,
  };
}
```

**ZO API Request**:
```
POST https://api.io.zo.xyz/api/v1/profile/me/
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  client-key: <ZO_CLIENT_KEY_WEB>
  client-device-id: dev_abc123
  client-device-secret: secret_xyz789
  Content-Type: application/json
Body:
{
  "first_name": "samurai",
  "body_type": "bro",
  "place_name": "San Francisco"
}
```

**âœ… Confirmed**: Both web and mobile apps now use `POST /api/v1/profile/me/` (the canonical method).

**Difference**: Mobile app only sends `body_type`, while web app sends multiple fields in one request for efficiency:
```json
// Mobile approach (separate requests)
{ "body_type": "bro" }

// Web approach (combined request)
{ "first_name": "samurai", "body_type": "bro", "place_name": "San Francisco" }
```

Both approaches are valid - web app is more efficient with fewer API calls.

**ZO API Response**:
```json
{
  "id": "usr_abc123",
  "pid": "p_xyz789",
  "first_name": "samurai",
  "place_name": "San Francisco",
  "body_type": "bro",
  "avatar": {
    "image": null,
    "status": "processing"
  }
}
```

**CRITICAL**: The ZO API backend **automatically triggers avatar generation** when it receives a profile update with `body_type`. This is NOT a separate API call - the avatar generation is initiated server-side as a side effect of the POST request.

**What Happens on ZO Backend**:
- ZO API receives PATCH with `body_type: "bro"`
- Backend queues avatar generation job (async)
- Returns immediately with `avatar.status = "processing"`
- Avatar is generated in background (takes 5-30 seconds)
- Avatar URL is stored in ZO database when ready
- Subsequent GET requests will show `avatar.image` and `avatar.status = "completed"`

**API Call 2: Poll for Avatar**

```typescript
const startPolling = async (
  accessToken: string,
  userId: string,
  bodyType: 'bro' | 'bae'
) => {
  let attempts = 0;
    const maxAttempts = 15; // 30 seconds max (web app)
  // Note: Mobile app uses 10 attempts with 1-second interval = 10 seconds total

  const poll = async () => {
    attempts++;
    
    // Fetch profile from ZO API
    const { getProfile } = await import('@/lib/zo-api/profile');
    const result = await getProfile(accessToken, userId);
    
    const profile = result.profile;
    
    // Check if avatar is ready
    if (profile.avatar?.image && profile.avatar.image.length > 0) {
      // SUCCESS! Avatar is ready
      setAvatarUrl(profile.avatar.image);
      
      // Save to Supabase
      await updateUserProfile(userId, {
        pfp: profile.avatar.image,
        body_type: bodyType
      });
      
      // Auto-advance after 2 seconds
      setTimeout(() => onAvatarSet(), 2000);
      
      return; // Stop polling
    }
    
    // Avatar not ready yet
    if (attempts < maxAttempts) {
      setTimeout(poll, 2000); // Poll every 2 seconds (web app)
      // Note: Mobile app polls every 1 second
    } else {
      // TIMEOUT - Use fallback
      useFallbackAvatar();
    }
  };

  poll();
};
```

**âœ… Polling Implementation (Aligned with Mobile)**:

| Aspect | Web App | Mobile App (Source of Truth) |
|--------|---------|-------------------------------|
| Polling Interval | 1 second | 1 second âœ… |
| Max Attempts | 30 | 10 |
| Total Wait Time | 30 seconds | 10 seconds |
| On Timeout | Use fallback unicorn avatar | Continue without avatar |

**Note**: Web app uses longer timeout (30s vs 10s) to provide better UX with fallback avatar strategy.

**Mobile App Implementation** (from actual code):
```typescript
// Mobile app polling logic
const counter = useRef(0);

const checkAvatar = useCallback(() => {
  counter.current++;
  if (counter.current > 10) {  // 10 attempts = 10 seconds
    onSubmit();  // Continue onboarding without avatar
    return;
  }
  refetchProfile()  // GET /api/v1/profile/me/
    .then((data) => {
      if (isValidString(data.data?.avatar?.image)) {
        showAvatar();  // Avatar ready
      } else {
        setTimeout(checkAvatar, 1000);  // Retry in 1 second
      }
    })
    .catch((er) => {
      logAxiosError(er);
      setTimeout(checkAvatar, 1000);  // Retry on error
    });
}, [refetchProfile, showAvatar]);
```

**ZO API Request** (polling):
```
GET https://api.io.zo.xyz/api/v1/profile/me/
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  client-key: <ZO_CLIENT_KEY_WEB>
  client-device-id: dev_abc123
  client-device-secret: secret_xyz789
```

**ZO API Response** (attempt 1-10):
```json
{
  "id": "usr_abc123",
  "avatar": {
    "image": null,
    "status": "processing"
  }
}
```

**ZO API Response** (attempt 11 - SUCCESS):
```json
{
  "id": "usr_abc123",
  "avatar": {
    "image": "https://cdn.zo.xyz/avatars/usr_abc123_bro.png",
    "status": "completed"
  }
}
```

**SQL UPDATE**:
```sql
UPDATE users
SET 
  pfp = 'https://cdn.zo.xyz/avatars/usr_abc123_bro.png',
  body_type = 'bro',
  updated_at = '2025-11-23T12:01:30Z'
WHERE id = 'usr_abc123';
```

**Database State After Avatar Step**:
```
users table (usr_abc123):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ name      â”‚ city             â”‚ body_type â”‚ pfp                                         â”‚ updated_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ samurai   â”‚ San Francisco    â”‚ bro       â”‚ https://cdn.zo.xyz/avatars/usr_abc123_bro.png â”‚ 2025-11-23T12:01:30Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 4.3: Citizen Card Step

**File**: `apps/web/src/components/CitizenCard.tsx`

**UI**:
- Title: "Welcome to Zo World"
- User's avatar (from database)
- User's nickname (from database)
- "Quantum Sync" button

**User Action**: Clicks "Quantum Sync"

**Frontend Logic**:
```typescript
const handleQuantumSync = () => {
  onComplete(); // Move to portal animation
};
```

**No API calls or database updates** - purely UI transition.

---

#### 4.4: Portal Animation Step

**File**: `apps/web/src/components/PortalAnimation.tsx`

**UI**:
- Animated opening disks
- Stone portal animation
- Auto-advances after animation completes (~3 seconds)

**Frontend Logic**:
```typescript
useEffect(() => {
  const timer = setTimeout(() => {
    onComplete(); // Move to voice quest
  }, 3000);
  
  return () => clearTimeout(timer);
}, []);
```

**No API calls or database updates** - purely visual.

---

## ğŸ¤ STEP 5: Voice Quest (Game1111)

**File**: `apps/web/src/components/QuestAudio.tsx`

**UI**:
- Title: "Hold & Chant 'Zo Zo Zo'"
- Microphone button (hold to record)
- Recording timer (3 seconds)

**User Action**: Holds microphone button and says "Zo Zo Zo"

**Frontend Logic**:
1. Start recording audio (MediaRecorder API)
2. Start speech recognition (Web Speech API)
3. After 3 seconds, stop recording
4. Upload audio to backend for transcription
5. Validate transcription contains "zo"
6. Submit quest completion

**API Call 1: Transcribe Audio**

```typescript
const formData = new FormData();
formData.append('audio', audioBlob, 'recording.webm');

const response = await fetch('/api/transcribe', {
  method: 'POST',
  body: formData,
});

const data = await response.json();
const transcript = data.text;
```

**Backend Route**: `apps/web/src/app/api/transcribe/route.ts`

**Backend Implementation**:
```typescript
export async function POST(request: NextRequest) {
  const formData = await request.formData();
  const audioFile = formData.get('audio') as File;
  
  // Upload to AssemblyAI
  const uploadResponse = await fetch('https://api.assemblyai.com/v2/upload', {
    method: 'POST',
    headers: {
      'authorization': process.env.ASSEMBLYAI_API_KEY!,
    },
    body: await audioFile.arrayBuffer(),
  });
  
  const { upload_url } = await uploadResponse.json();
  
  // Request transcription
  const transcriptResponse = await fetch('https://api.assemblyai.com/v2/transcript', {
    method: 'POST',
    headers: {
      'authorization': process.env.ASSEMBLYAI_API_KEY!,
      'content-type': 'application/json',
    },
    body: JSON.stringify({
      audio_url: upload_url,
    }),
  });
  
  const { id: transcriptId } = await transcriptResponse.json();
  
  // Poll for completion
  let transcript;
  while (true) {
    const statusResponse = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
      headers: {
        'authorization': process.env.ASSEMBLYAI_API_KEY!,
      },
    });
    
    transcript = await statusResponse.json();
    
    if (transcript.status === 'completed' || transcript.status === 'error') {
      break;
    }
    
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  return NextResponse.json({
    text: transcript.text,
    confidence: transcript.confidence,
  });
}
```

**AssemblyAI Response**:
```json
{
  "text": "zo zo zo",
  "confidence": 0.95
}
```

**Validation**:
```typescript
const containsZo = transcript.toLowerCase().includes('zo');

if (containsZo) {
  // Quest validated! Submit completion
  submitQuestCompletion();
}
```

**API Call 2: Submit Quest Completion**

```typescript
const response = await fetch('/api/quests/submit', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: userId,
    questId: 'game1111',
    score: 1111,
    proof: {
      transcript: transcript,
      timestamp: Date.now(),
    },
  }),
});
```

**Backend Route**: `apps/web/src/app/api/quests/submit/route.ts`

**SQL INSERT**:
```sql
INSERT INTO quest_submissions (
  user_id,
  quest_id,
  score,
  proof,
  submitted_at,
  status
) VALUES (
  'usr_abc123',
  'game1111',
  1111,
  '{"transcript":"zo zo zo","timestamp":1732368090000}',
  '2025-11-23T12:02:00Z',
  'completed'
)
RETURNING *;
```

**SQL UPDATE** (mark onboarding complete):
```sql
UPDATE users
SET 
  onboarding_completed = TRUE,
  onboarding_step = 4,
  updated_at = '2025-11-23T12:02:01Z'
WHERE id = 'usr_abc123';
```

**Database State After Quest**:
```
users table (usr_abc123):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ name      â”‚ onboarding_completed â”‚ updated_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ samurai   â”‚ TRUE                 â”‚ 2025-11-23T12:02:01Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

quest_submissions table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id      â”‚ quest_id  â”‚ score â”‚ proof                                        â”‚ submitted_at         â”‚ status    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ game1111  â”‚ 1111  â”‚ {"transcript":"zo zo zo","timestamp":...}    â”‚ 2025-11-23T12:02:00Z â”‚ completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ STEP 6: Quest Results & Dashboard

**File**: `apps/web/src/components/QuestComplete.tsx`

**UI**:
- Success animation
- "Quest Complete!" message
- Points earned: +100
- Auto-advances to dashboard after 3 seconds

**Frontend Logic**:
```typescript
useEffect(() => {
  const timer = setTimeout(() => {
    // Reload profile to get updated onboarding status
    reloadProfile();
    
    // Navigate to dashboard
    router.push('/dashboard');
  }, 3000);
  
  return () => clearTimeout(timer);
}, []);
```

**Dashboard Load**:

**File**: `apps/web/src/app/page.tsx`

```typescript
if (hasCompletedOnboarding) {
  return <DashboardView />;
}
```

**Dashboard fetches user data**:

**Hook**: `useDashboardData()` in `apps/web/src/hooks/useDashboardData.ts`

**Queries**:
```sql
-- User profile
SELECT * FROM users WHERE id = 'usr_abc123';

-- User quests
SELECT * FROM quest_submissions WHERE user_id = 'usr_abc123';

-- Leaderboard
SELECT * FROM leaderboards WHERE city = 'San Francisco' ORDER BY rank ASC LIMIT 10;

-- Events
SELECT * FROM canonical_events WHERE city = 'San Francisco' AND start_time > NOW() ORDER BY start_time ASC LIMIT 10;

-- Nodes
SELECT * FROM nodes WHERE city = 'San Francisco';
```

---

## ğŸ“Š Final Database State

After a brand new user completes the entire funnel:

```
users table (usr_abc123):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id           â”‚ zo_user_id   â”‚ zo_pid    â”‚ name      â”‚ phone       â”‚ email            â”‚ pfp                                         â”‚ body_type â”‚ city             â”‚ role      â”‚ onboarding_completed â”‚ created_at           â”‚ updated_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ usr_abc123   â”‚ p_xyz789  â”‚ samurai   â”‚ 5551234567  â”‚ john@example.com â”‚ https://cdn.zo.xyz/avatars/usr_abc123_bro.png â”‚ bro       â”‚ San Francisco    â”‚ Member    â”‚ TRUE                 â”‚ 2025-11-23T12:00:00Z â”‚ 2025-11-23T12:02:01Z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Additional fields:
- zo_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
- zo_refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
- zo_device_id: "dev_abc123"
- zo_device_secret: "secret_xyz789"
- zo_synced_at: "2025-11-23T12:00:03Z"
- cultures: []
- founder_nfts_count: 0
- primary_wallet_address: "0x1234567890abcdef"
- zo_membership: "citizen"
- zo_balance: 0
- total_reputation_score: 0
- onboarding_step: 4

quest_submissions table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id      â”‚ quest_id  â”‚ score â”‚ proof                                        â”‚ submitted_at         â”‚ status    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usr_abc123   â”‚ game1111  â”‚ 1111  â”‚ {"transcript":"zo zo zo","timestamp":...}    â”‚ 2025-11-23T12:02:00Z â”‚ completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

localStorage:
- zo_user_id: "usr_abc123"
- zo_access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
- zo_refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
- zo_token_expiry: "2025-11-24T12:00:00Z"
- zo_nickname: "samurai"
- zo_city: "San Francisco"
- zo_body_type: "bro"
```

---

## ğŸ”‘ Key Takeaways

### User Creation Happens in 3 Phases:

1. **Initial INSERT** (in `verify-otp` route):
   - Creates minimal user record with ZO identity
   - Fields: `id`, `zo_user_id`, `zo_pid`, `name`, `phone`, `email`

2. **Profile Sync** (via `syncZoProfileToSupabase`):
   - Fetches full profile from ZO API
   - Updates: `pfp`, `cultures`, `wallet_address`, `founder_nfts_count`, etc.

3. **Onboarding Updates** (via `upsertUser` and `updateUserProfile`):
   - User-provided data: `name` (nickname), `city`, `body_type`
   - Generated data: `pfp` (avatar URL from ZO API)
   - Completion flag: `onboarding_completed = TRUE`

### Critical API Endpoints:

1. **ZO API - Send OTP**: `POST /api/v1/auth/login/mobile/otp/`
2. **ZO API - Verify OTP**: `POST /api/v1/auth/login/mobile/`
3. **ZO API - Get Profile**: `GET /api/v1/profile/me/`
4. **ZO API - Update Profile**: `POST /api/v1/profile/me/`
5. **Internal - Verify OTP**: `POST /api/zo/auth/verify-otp`
6. **Internal - Transcribe Audio**: `POST /api/transcribe`
7. **Internal - Submit Quest**: `POST /api/quests/submit`

### Database Tables Involved:

1. **`users`** - Main user profile (created, updated multiple times)
2. **`quest_submissions`** - Quest completion records (inserted once)
3. **`user_wallets`** - Wallet addresses (upserted during sync)

### External Services:

1. **ZO API** (`https://api.io.zo.xyz`) - Authentication, profile, avatar
2. **AssemblyAI** (`https://api.assemblyai.com`) - Audio transcription
3. **BigDataCloud** (`https://api.bigdatacloud.net`) - Reverse geocoding

---

## ğŸš¨ Edge Cases & Error Handling

### 1. User Already Exists (Phone Number Collision)

**Scenario**: User enters phone number that's already in database.

**Handling**:
```typescript
// In verify-otp route
const { data: existingByPhone } = await supabase
  .from('users')
  .select('id')
  .eq('phone', user.mobile_number)
  .single();

if (existingByPhone) {
  // User exists - update their ZO credentials
  targetUserId = existingByPhone.id;
  // Continue with auth data update
}
```

**Result**: Existing user is updated with new ZO credentials, not duplicated.

---

### 2. Avatar Generation Timeout

**Scenario**: ZO API takes >30 seconds to generate avatar.

**Handling**:
```typescript
if (attempts >= maxAttempts) {
  // Use fallback unicorn avatar
  const fallbackAvatar = bodyType === 'bro' 
    ? '/unicorn images/UnicornMemes_v1-01.png'
    : '/unicorn images/UnicornMemes_v1-02.png';
  
  setAvatarUrl(fallbackAvatar);
  
  // Save fallback to database
  await updateUserProfile(userId, {
    pfp: fallbackAvatar,
    body_type: bodyType
  });
}
```

**Result**: User gets a fallback avatar and can continue onboarding.

---

### 3. Voice Transcription Failure

**Scenario**: AssemblyAI fails or returns empty transcript.

**Handling**:
```typescript
if (!transcript || transcript.trim().length === 0) {
  // Show error alert
  alert('Transcription failed. Please try again.');
  
  // Reset to idle state for retry
  setAudioStatus('idle');
  return;
}
```

**Result**: User can retry the voice quest immediately.

---

### 4. Network Failure During Onboarding

**Scenario**: User loses internet connection during avatar generation.

**Handling**:
```typescript
try {
  const result = await getProfile(accessToken, userId);
} catch (err) {
  console.error('âŒ Error polling for avatar:', err);
  
  // Retry on error (unless max attempts reached)
  if (attempts < maxAttempts) {
    setTimeout(poll, 2000);
  } else {
    useFallbackAvatar();
  }
}
```

**Result**: Polling retries automatically, or falls back to unicorn avatar.

---

## ğŸ“ˆ Performance Metrics

### Typical Timing:

1. **Phone OTP Send**: 1-2 seconds
2. **OTP Verification + DB Creation**: 2-3 seconds
3. **Profile Sync from ZO API**: 1-2 seconds
4. **Nickname Step**: User-dependent (30-60 seconds)
5. **Avatar Generation**: 10-30 seconds
6. **Voice Quest**: User-dependent (5-10 seconds)

**Total Time**: ~2-3 minutes for a typical new user.

---

## ğŸ”’ Security Considerations

### 1. Device Credentials

- Generated once per device
- Stored in localStorage and Supabase
- Required for all ZO API calls
- Never exposed to client-side logs

### 2. Access Tokens

- JWT format
- Expires after 24 hours
- Automatically refreshed using refresh token
- Stored in localStorage (client-side)

### 3. OTP Validation

- 6-digit code
- Expires after 5 minutes
- Rate-limited by ZO API
- Single-use only

### 4. Quest Proof

- Timestamped
- Includes audio transcript
- Stored as JSONB in database
- Replay protection via timestamp validation

---

## ğŸ¯ Success Criteria

A new user is considered "fully onboarded" when:

1. âœ… User record exists in `users` table
2. âœ… `onboarding_completed = TRUE`
3. âœ… `onboarding_step = 4`
4. âœ… User has a `pfp` (avatar URL)
5. âœ… User has a `name` (nickname)
6. âœ… User has completed at least 1 quest
7. âœ… User has valid `zo_token` and `zo_refresh_token`
8. âœ… User has `zo_device_id` and `zo_device_secret`

---

## ğŸ“ Summary

The new user funnel is a **7-step process** that creates a fully authenticated and onboarded user:

1. **Landing Page** - User clicks "Tune into Zo World"
2. **Phone Auth** - User enters phone + OTP
3. **DB Creation** - User record inserted into Supabase
4. **Profile Sync** - Full profile synced from ZO API
5. **Onboarding** - User sets nickname, body type, city, and generates avatar
6. **Voice Quest** - User completes Game1111 quest
7. **Dashboard** - User is fully onboarded and can access the app

**Key Database Operations**:
- 1x INSERT (initial user creation)
- 3x UPDATE (device credentials, auth data, profile sync)
- 1x UPSERT (nickname + body type)
- 1x UPDATE (avatar URL)
- 1x UPDATE (onboarding completion)
- 1x INSERT (quest submission)

**Total Database Writes**: 8 operations

**External API Calls**:
- 2x ZO API (send OTP, verify OTP)
- 2x ZO API (get profile, update profile)
- 15x ZO API (polling for avatar, max)
- 1x AssemblyAI (transcribe audio)
- 1x BigDataCloud (reverse geocoding, optional)

**Total External API Calls**: 21 calls (max)

---

**End of Deep Dive Analysis**

